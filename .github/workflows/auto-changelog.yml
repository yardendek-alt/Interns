name: Auto Update Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          
      - name: Start Ollama and pull model
        run: |
          ollama serve &
          sleep 5
          ollama pull llama3.2
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests

      - name: Generate AI changelog entry
        env:
          TZ: Asia/Jerusalem
        run: |
          python << 'EOF'
          import requests
          import subprocess
          from datetime import datetime
          import os
          os.environ['TZ'] = 'Asia/Jerusalem'
          
          # Get git diff
          diff = subprocess.run(
              ["git", "diff", "HEAD~1", "HEAD"],
              capture_output=True, text=True
          ).stdout[:4000]
          
          pr_title = "${{ github.event.pull_request.title }}"
          pr_number = "${{ github.event.pull_request.number }}"
          
          timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          
          if diff.strip():
              prompt = f"""Analyze this git diff and provide a summary in exactly 2 bullet points.
          Each bullet point should describe a key change. Format: start each with '- '
          
          Git diff:
          {diff}
          
          Provide only the 2 bullet points, nothing else."""
              
              try:
                  response = requests.post(
                      "http://localhost:11434/api/generate",
                      json={"model": "llama3.2", "prompt": prompt, "stream": False},
                      timeout=120
                  )
                  if response.status_code == 200:
                      summary = response.json().get("response", "").strip()
                  else:
                      summary = f"- PR #{pr_number}: {pr_title}\n- Merged successfully"
              except Exception as e:
                  print(f"Ollama error: {e}")
                  summary = f"- PR #{pr_number}: {pr_title}\n- Merged successfully"
          else:
              summary = f"- PR #{pr_number}: {pr_title}\n- Merged successfully"
          
          entry = f"\n## Merge on {timestamp}\n\n**PR #{pr_number}:** {pr_title}\n\n{summary}\n"
          
          with open("Change_Log.md", "a") as f:
              f.write(entry)
          
          print(f"Changelog updated:\n{entry}")
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Change_Log.md
          git diff --staged --quiet || git commit -m "Auto-update changelog for PR #${{ github.event.pull_request.number }}"
          git push
