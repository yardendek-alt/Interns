name: Auto Update Changelog

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install groq

      - name: Generate AI changelog entry
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          from datetime import datetime
          
          # Get git diff
          diff = subprocess.run(
              ["git", "diff", "HEAD~1", "HEAD"],
              capture_output=True, text=True
          ).stdout[:4000]  # Limit size
          
          # Get timestamp
          timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          
          # Check if GROQ_API_KEY exists
          api_key = os.getenv("GROQ_API_KEY")
          
          if api_key and diff.strip():
              try:
                  from groq import Groq
                  client = Groq(api_key=api_key)
                  
                  response = client.chat.completions.create(
                      model="llama-3.1-8b-instant",
                      messages=[{
                          "role": "user",
                          "content": f"""Analyze this git diff and provide a summary in exactly 2 bullet points.
          Each bullet point should describe a key change. Format: start each with '- '
          
          Git diff:
          {diff}
          
          Provide only the 2 bullet points, nothing else."""
                      }],
                      max_tokens=200
                  )
                  summary = response.choices[0].message.content.strip()
              except Exception as e:
                  print(f"AI error: {e}")
                  summary = "- Changes merged from pull request\n- See commit history for details"
          else:
              summary = "- Changes merged from pull request\n- See commit history for details"
          
          # Create entry
          entry = f"\n## Merge on {timestamp}\n\n{summary}\n"
          
          # Append to changelog
          with open("Change_Log.md", "a") as f:
              f.write(entry)
          
          print(f"Added changelog entry:\n{entry}")
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Change_Log.md
          git diff --staged --quiet || git commit -m "Auto-update changelog for PR #${{ github.event.pull_request.number }}"
          git push
